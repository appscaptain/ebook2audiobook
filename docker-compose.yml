version: "3.8"

services:
  # -----------------------------------------------------
  # SERVICE 1: PDF Cleaner (Uses Dockerfile.cleaner)
  # -----------------------------------------------------
  pdf-cleaner:
    build:
      context: .
      dockerfile: Dockerfile.cleaner
    container_name: pdf-cleaner
    restart: unless-stopped
    volumes:
      # SHARED VOLUME: Both apps will see this data
      - audiobook-data:/app/data
    deploy:
      resources:
        limits:
          memory: 4g

  # -----------------------------------------------------
  # SERVICE 2: Ebook2Audiobook (Uses standard Dockerfile)
  # -----------------------------------------------------
  ebook2audiobook:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        DOCKER_DEVICE_STR: "cpu"
    container_name: ebook2audiobook
    restart: unless-stopped
    ports:
      - "7860:7860"
    environment:
      - CUDA_VISIBLE_DEVICES=-1
      - TTS_ENGINE=edge
    volumes:
      # Mounts the same volume as the cleaner
      - audiobook-data:/app/results
      # Dsiabled because Error: In headless mode, you must specify either an ebook file using --ebook or an ebook directory using --ebooks_dir.
    # command: ["--headless"]
    deploy:
      resources:
        limits:
          memory: 4g

volumes:
  audiobook-data:
